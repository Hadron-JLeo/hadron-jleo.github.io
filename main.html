<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB User Shop</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .avatar, .shop-item { display: inline-block; margin: 10px; text-align: center; }
        .avatar img, .shop-item img { width: 100px; height: 100px; cursor: pointer; border: 2px solid transparent; }
        .avatar img.selected, .shop-item img:hover { border: 2px solid blue; }
    </style>
</head>
<body>
    <h1>User Shop with IndexedDB</h1>

    <div id="createUserSection">
        <h2>Create User</h2>
        <input type="text" id="username" placeholder="Enter your name">
        <div id="avatars">
            <div class="avatar">
                <img src="avatar1.png" alt="Avatar 1" onclick="selectAvatar('avatar1.png')">
                <p>Avatar 1</p>
            </div>
            <div class="avatar">
                <img src="avatar2.png" alt="Avatar 2" onclick="selectAvatar('avatar2.png')">
                <p>Avatar 2</p>
            </div>
        </div>
        <button onclick="createUser()">Create User</button>
    </div>

    <div id="shopSection" style="display:none;">
        <h2>Welcome, <span id="currentUser"></span>!</h2>
        <p>Points: <span id="userPoints">5</span></p>
        <p>Items: <span id="userItems">None</span></p>

        <h3>Shop</h3>
        <div id="shopItems">
            <div class="shop-item">
                <img src="item1.png" alt="Item 1" onclick="purchaseItem('Item 1', 3, 'item1.png')">
                <p>Item 1 - 3 Points</p>
            </div>
            <div class="shop-item">
                <img src="item2.png" alt="Item 2" onclick="purchaseItem('Item 2', 5, 'item2.png')">
                <p>Item 2 - 5 Points</p>
            </div>
        </div>
    </div>

    <script>
        let selectedAvatar = null;
        const dbName = "UserShopDB";

        // Open or create the database
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains("users")) {
                        const userStore = db.createObjectStore("users", { keyPath: "name" });
                    }
                };
                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        // Select an avatar
        function selectAvatar(avatar) {
            selectedAvatar = avatar;
            document.querySelectorAll('.avatar img').forEach(img => img.classList.remove('selected'));
            document.querySelector(`img[src='${avatar}']`).classList.add('selected');
        }

        // Create a new user
        async function createUser() {
            const username = document.getElementById("username").value;
            if (!username || !selectedAvatar) {
                alert("Please enter a name and select an avatar.");
                return;
            }

            const db = await openDatabase();
            const transaction = db.transaction("users", "readwrite");
            const store = transaction.objectStore("users");

            const user = {
                name: username,
                avatar: selectedAvatar,
                points: 5,
                items: []
            };

            store.put(user);
            alert("User created successfully!");
            document.getElementById("createUserSection").style.display = "none";
            document.getElementById("shopSection").style.display = "block";
            loadUser(username);
        }

        // Load user data
        async function loadUser(username) {
            const db = await openDatabase();
            const transaction = db.transaction("users", "readonly");
            const store = transaction.objectStore("users");
            const request = store.get(username);

            request.onsuccess = function(event) {
                const user = event.target.result;
                if (user) {
                    document.getElementById("currentUser").innerText = user.name;
                    document.getElementById("userPoints").innerText = user.points;
                    document.getElementById("userItems").innerText = user.items.length > 0 ? user.items.join(', ') : "None";
                }
            };
        }

        // Purchase an item
        async function purchaseItem(itemName, cost, image) {
            const username = document.getElementById("currentUser").innerText;
            const db = await openDatabase();
            const transaction = db.transaction("users", "readwrite");
            const store = transaction.objectStore("users");
            const request = store.get(username);

            request.onsuccess = function(event) {
                const user = event.target.result;
                if (user.points >= cost) {
                    user.points -= cost;
                    user.items.push(itemName);

                    store.put(user);

                    alert(`You purchased ${itemName}!`);
                    document.getElementById("userPoints").innerText = user.points;
                    document.getElementById("userItems").innerText = user.items.join(', ');
                } else {
                    alert("Not enough points!");
                }
            };
        }
    </script>
</body>
</html>
